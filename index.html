<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>가중치 돌림판 (Weighted Roulette)</title>
<style>
  :root{ --bg:#0b1020; --panel:#141a2e; --accent:#6ea8fe; --muted:#9fb3c8; }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
    background:linear-gradient(180deg,#0a0f1e 0%,#0b1020 60%,#0a0f1e 100%); color:#e8f0ff;
  }
  header{padding:18px 16px 6px; text-align:center}
  header h1{margin:0; font-size:20px}
  header p{margin:6px 0 0; color:var(--muted); font-size:13px}

  .wrap{display:grid; grid-template-columns:1fr; gap:12px; padding:12px; max-width:1000px; margin:0 auto}
  @media (min-width:960px){ .wrap{grid-template-columns:1.2fr .8fr; padding:16px; gap:16px} }

  .card{
    background:rgba(20,26,46,.7); border:1px solid rgba(255,255,255,.06);
    border-radius:16px; padding:14px; backdrop-filter: blur(6px);
    box-shadow: 0 6px 20px rgba(0,0,0,.35);
  }
  .card h2{margin:0 0 10px; font-size:16px; color:#e9efff}

  .board{display:grid; place-items:center; padding:8px 8px 16px;}
  .wheel-shell{ position:relative; width:min(90vw,520px); aspect-ratio:1; }
  .wheel-rotor{ width:100%; height:100%; transition: transform 4.2s cubic-bezier(.14,.75,.25,1); will-change:transform; }
  canvas{ width:100%; height:100%; display:block; border-radius:50%; }

  .pointer{
    position:absolute; left:50%; top:-8px; transform:translateX(-50%);
    width:0; height:0; border-left:12px solid transparent; border-right:12px solid transparent;
    border-bottom:18px solid #ffd166; filter: drop-shadow(0 2px 2px rgba(0,0,0,.5));
  }

  .controls{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px}
  button, .btn{
    background:linear-gradient(180deg,#233055,#1a2341); color:#e8f0ff; border:1px solid rgba(255,255,255,.1);
    padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
  }
  button:hover{filter:brightness(1.06)}
  .btn-accent{background:linear-gradient(180deg,#3b5bcc,#294ab3)}
  .btn-danger{background:linear-gradient(180deg,#7a2330,#671c27)}

  .result{text-align:center; margin-top:10px; font-size:15px; color:#d9e6ff;}
  .result strong{font-size:18px; color:#fff}
  .hint{font-size:12px; color:var(--muted); text-align:center; margin-top:6px}
  .recent{margin-top:8px; font-size:13px; color:#cfe1ff}

  .rows{margin-top:8px; border-top:1px dashed rgba(255,255,255,.08); padding-top:8px; max-height:50vh; overflow:auto}
  .row{display:grid; grid-template-columns:1fr 110px; gap:8px; align-items:center; margin:6px 0;}
  .row input{padding:9px 10px}
  .summary{display:flex; justify-content:space-between; font-size:12px; color:#cfe1ff; margin-top:6px}
  .sum-ok{color:#86efac} .sum-warn{color:#facc15}

  .share{margin-top:10px; display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
  .share input{padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:#0f1529; color:#eaf1ff;}

  .toggle{display:flex; align-items:center; gap:8px; margin-top:8px; font-size:13px; color:#cfe1ff}
  .toggle input{width:40px; height:20px}
</style>
</head>
<body>
<header>
  <h1>가중치 돌림판</h1>
  <p>항목 이름과 확률을 수정할 수 있습니다. (확률 합이 100%가 아니면 라벨은 자동 정규화 비율로 표시돼요)</p>
</header>

<main class="wrap">
  <!-- WHEEL -->
  <section class="card board">
    <h2>돌림판</h2>
    <div class="wheel-shell">
      <div class="pointer" aria-hidden="true"></div>
      <div id="wheel-rotor" class="wheel-rotor" aria-live="polite" aria-label="roulette wheel">
        <canvas id="wheel" width="700" height="700"></canvas>
      </div>
    </div>
    <div class="controls">
      <button id="spinBtn" class="btn btn-accent">🎯 돌리기</button>
      <button id="resetBtn" class="btn btn-danger">♻ 기본값으로 초기화</button>
    </div>
    <div class="result" id="resultBox">결과가 여기에 표시됩니다</div>
    <div class="hint">추첨은 <code>crypto.getRandomValues()</code> 기반으로 수행됩니다.</div>
    <div class="recent" id="recentBox" aria-live="polite"></div>
  </section>

  <!-- SETTINGS -->
  <section class="card">
    <h2>항목 & 확률(%)</h2>

    <div class="summary">
      <span id="countBadge">항목 5개</span>
      <span>합계: <strong id="sumWeight">0%</strong></span>
    </div>

    <div class="rows" id="rows"></div>

    <div class="toggle">
      <label for="showPct"><input type="checkbox" id="showPct"> 라벨에 확률(%) 표시</label>
    </div>

    <div class="share">
      <input id="shareLink" readonly placeholder="공유 링크가 여기에 생성됩니다" />
      <button id="copyBtn" class="btn">링크 복사</button>
    </div>
  </section>
</main>

<script>
/* ===== Config ===== */
const LABEL_OFFSET_RATIO = 0.48; // 라벨 위치 (반지름 * 0.48)

/* ===== Utilities ===== */
const $ = (sel)=>document.querySelector(sel);

function cryptoRandom(){ const u32 = new Uint32Array(1); crypto.getRandomValues(u32); return u32[0] / 2**32; }
function encodeConfig(cfg){ const json = JSON.stringify(cfg); return btoa(unescape(encodeURIComponent(json))); }
function decodeConfig(safe){ try{ const json = decodeURIComponent(escape(atob(safe))); return JSON.parse(json);}catch(e){ return null; }}

/* ===== Defaults (요청한 순서/색/초기 확률) =====
   꽝 - 10 / 0.5배 - 25 / 그대로 - 30 / 2배 - 30 / 4배 - 5
*/
const DEFAULT_ITEMS = [
  { name:"꽝",   color:"#F59B95", weight:10 },
  { name:"0.5배", color:"#F0A84A", weight:25 },
  { name:"그대로", color:"#B3D966", weight:30 },
  { name:"2배",   color:"#F7CB3F", weight:30 },
  { name:"4배",   color:"#9DC0E5", weight:5  },
];

let state = { items: [], spinDeg: 0, recent: [], showPct: true };
const LS_KEY = "weighted_roulette_editable_v1";

function sumWeights(){ return state.items.reduce((s,it)=>s+(+it.weight||0),0); }

/* ===== Persistence ===== */
function saveState(pushURL=true){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  // 공유 링크에 이름+확률 포함 (개인 설정인 showPct는 제외)
  const share = location.origin + location.pathname + "#cfg=" + encodeConfig({
    items: state.items.map(({name,weight})=>({name,weight}))
  });
  $("#shareLink").value = share;
  if(pushURL) history.replaceState(null, "", share);
}

function loadState(){
  let loadedItems = null;

  // URL 해시 우선
  const hash = location.hash || "";
  if(hash.startsWith("#cfg=")){
    const cfg = decodeConfig(hash.slice(5));
    if(cfg && Array.isArray(cfg.items) && cfg.items.length===5){
      loadedItems = cfg.items.map((it,i)=>({
        name: String(it.name ?? DEFAULT_ITEMS[i].name).slice(0,100),
        weight: Math.max(0, Number(it.weight)||0),
        color: DEFAULT_ITEMS[i].color, // 색상은 슬롯 고정
      }));
    } else if (cfg && Array.isArray(cfg.weights) && cfg.weights.length===5){
      // 하위 호환: 예전 포맷(가중치만)
      loadedItems = DEFAULT_ITEMS.map((d,i)=>({ name:d.name, weight:Math.max(0,Number(cfg.weights[i])||0), color:d.color }));
    }
  }

  // LocalStorage
  const saved = localStorage.getItem(LS_KEY);
  if(saved){
    try{
      const s = JSON.parse(saved);
      state.recent = Array.isArray(s.recent) ? s.recent : [];
      state.showPct = typeof s.showPct === "boolean" ? s.showPct : true;
      if(!loadedItems && Array.isArray(s.items) && s.items.length===5){
        loadedItems = s.items.map((it,i)=>({
          name: String(it.name ?? DEFAULT_ITEMS[i].name).slice(0,100),
          weight: Math.max(0, Number(it.weight)||0),
          color: DEFAULT_ITEMS[i].color
        }));
      }
    }catch(e){}
  }

  // 상태 구성
  state.items = (loadedItems ?? DEFAULT_ITEMS).map((it,i)=>({
    id: String(i), name: it.name, color: it.color, weight: it.weight
  }));

  // UI 스위치
  $("#showPct").checked = state.showPct;
}

/* ===== UI: Rows (이름 + 확률 입력 가능) ===== */
function renderRows(){
  const rows = $("#rows");
  rows.innerHTML = "";
  state.items.forEach((it, idx)=>{
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <input value="${it.name}" aria-label="항목 이름">
      <input type="number" min="0" step="0.1" value="${it.weight}" aria-label="확률(%)">
    `;
    const [nameEl, weightEl] = row.children;

    nameEl.addEventListener("input", ()=>{
      it.name = nameEl.value.slice(0,100);
      drawWheel();
      saveState();
    });
    weightEl.addEventListener("input", ()=>{
      it.weight = Math.max(0, Number(weightEl.value)||0);
      drawWheel();
      updateSummary();
      saveState();
    });

    rows.appendChild(row);
  });

  updateSummary();
}

function updateSummary(){
  const total = sumWeights();
  const sumEl = $("#sumWeight");
  sumEl.textContent = `${total.toFixed(1)}%`;
  sumEl.className = (Math.abs(total-100)<0.05) ? "sum-ok" : "sum-warn";
  $("#countBadge").textContent = `항목 ${state.items.length}개`;
}

/* ===== Wheel Drawing ===== */
const wheel = document.getElementById("wheel");
const ctx = wheel.getContext("2d");
const rotor = document.getElementById("wheel-rotor");
let slices = []; // {start,end,mid,name,color,weight}

function drawWheel(){
  const w = wheel.width, h = wheel.height;
  const cx = w/2, cy = h/2;
  const r = Math.min(w,h)/2 - 6;

  ctx.clearRect(0,0,w,h);

  const total = sumWeights();
  slices = [];
  if(total <= 0){
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle = "#1f2a48"; ctx.fill();
    ctx.fillStyle = "#cbd5e1"; ctx.font = "20px system-ui";
    ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("확률(%)을 입력하세요", cx, cy);
    return;
  }

  let start = -Math.PI/2;
  state.items.forEach((it)=>{
    const ratio = (Number(it.weight)||0)/total;     // 정규화된 비율
    const angle = ratio * Math.PI*2;
    const end = start + angle;

    // Slice
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end,false); ctx.closePath();
    ctx.fillStyle = it.color; ctx.fill();

    // Label (outside, auto-flip)
    const mid = (start+end)/2;
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(mid);

    const label = state.showPct ? `${it.name} (${(ratio*100).toFixed(1)}%)` : `${it.name}`;
    ctx.font = "bold 18px system-ui"; ctx.fillStyle = "#0b1020"; ctx.textBaseline = "middle";

    const offset = r * LABEL_OFFSET_RATIO;
    let angleDeg = mid * 180 / Math.PI;
    if (angleDeg > 90 && angleDeg < 270) {
      ctx.rotate(Math.PI); ctx.textAlign = "right"; ctx.fillText(label, -offset, 0);
    } else {
      ctx.textAlign = "left"; ctx.fillText(label, offset, 0);
    }
    ctx.restore();

    slices.push({start, end, mid, name:it.name, color:it.color, weight:it.weight});
    start = end;
  });

  // Center hub
  ctx.beginPath(); ctx.arc(cx,cy,48,0,Math.PI*2); ctx.fillStyle = "#0f1529"; ctx.fill();
  ctx.lineWidth = 2; ctx.strokeStyle = "rgba(255,255,255,.15)"; ctx.stroke();
}

/* ===== Spin Logic ===== */
function pickWeighted(){
  const total = sumWeights(); if(total<=0) return null;
  let t = cryptoRandom() * total;
  for(const s of state.items){ t -= Number(s.weight)||0; if(t <= 1e-12) return s; }
  return state.items[state.items.length-1];
}

function spin(){
  if(sumWeights()<=0) return;
  const targetItem = pickWeighted();
  const sl = slices.find(s=>s.name===targetItem.name); if(!sl) return;

  const deltaRad = sl.mid - (-Math.PI/2);
  let deltaDeg = deltaRad * 180/Math.PI;
  const fullTurns = 6 + Math.floor(cryptoRandom()*3);
  const sliceDeg = (sl.end - sl.start) * 180/Math.PI;
  const jitter = (cryptoRandom()*0.6 - 0.3) * sliceDeg;
  const targetDeg = (fullTurns*360) + deltaDeg + jitter;

  state.spinDeg += targetDeg;
  rotor.style.transition = "transform 4.2s cubic-bezier(.14,.75,.25,1)";
  rotor.style.transform = `rotate(${state.spinDeg}deg)`;

  rotor.ontransitionend = ()=>{
    document.getElementById("resultBox").innerHTML = `결과: <strong>${targetItem.name}</strong>`;
    state.recent = [targetItem.name, ...state.recent].slice(0,6);
    renderRecent(); saveState(false);
    rotor.ontransitionend = null;
  };
}

function renderRecent(){
  const box = document.getElementById("recentBox");
  if(!state.recent.length){ box.textContent = ""; return; }
  box.innerHTML = `최근 결과: ${state.recent.map(x=>`<span style="background:#1d2a52;border:1px solid rgba(255,255,255,.08);padding:3px 8px;border-radius:999px;">${x}</span>`).join(" ")}`;
}

/* ===== Events ===== */
document.getElementById("showPct").addEventListener("change", (e)=>{
  state.showPct = e.target.checked; drawWheel(); saveState();
});
document.getElementById("spinBtn").addEventListener("click", spin);
document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(confirm("항목과 확률을 기본값으로 되돌릴까요?")){
    state.items = DEFAULT_ITEMS.map((it,i)=>({ id:String(i), name:it.name, color:it.color, weight:it.weight }));
    state.recent = []; state.spinDeg = 0;
    drawWheel(); renderRows(); renderRecent(); updateSummary(); saveState();
    document.getElementById("wheel-rotor").style.transition="none";
    document.getElementById("wheel-rotor").style.transform="rotate(0deg)";
  }
});
document.getElementById("copyBtn").addEventListener("click", async ()=>{
  const link = document.getElementById("shareLink").value; if(!link) return;
  try{ await navigator.clipboard.writeText(link); alert("공유 링크 복사됨!"); }
  catch{ prompt("복사할 수 없어요. 아래 링크를 수동으로 복사하세요:", link); }
});

/* ===== Init ===== */
loadState();
drawWheel();
renderRows();
renderRecent();
saveState();
</script>
</body>
</html>
